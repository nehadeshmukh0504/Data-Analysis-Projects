---
title: "Statistical Analysis of Insurance Policies"
author: "Neha Deshmukh"
date: "8 August 2020"
output:
  html_document:
    df_print: paged
    highlight: tango
    self_contained: yes
    theme: paper
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
    fig.width: 7
    fig.height: 5 
    
---

<style type="text/css">

body{ /* Normal  */
      font-size: 16px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
  
}
h1 { /* Header 1 */
  font-size: 28px;
 
}
h2 { /* Header 2 */
    font-size: 22px;
 
}
h3 { /* Header 3 */
  font-size: 18px;
  
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
## install required packages if it's not already
if (!requireNamespace(c("data.table", "VIM", "outliers", "car", "ggpubr"), quietly = TRUE)) {
  install.packages(c("data.table", "VIM", "outliers", "car", "ggpubr"))
}
# Importing packages
library(tidyverse) 
library(car) 
library(zoo)
library(lmtest) 
library(dplyr) 
library(stringr)
library(caret)
library(ggplot2) 
library(timeDate)
library(varhandle)
library(gridExtra)
library(ggpubr)
library(Rmisc)
library(grid)
```

## About the data

<p>The data talks about details of customers who purchased different Auto Insurance Policies from the Company. For our CLV analysis, I have analysed the information of 9134 customers. There are 23 different variables. They are a mix of Categorical and Continous variables. In order to predict the CLV, the dependent variable from the dataset is Customer Lifetime Value.</p>

<p>Independent Variables are: Customer, StateCustomerLifetimeValue, Response, Coverage, Education, EffectiveToDate, EmploymentStatus, Gender, Income, LocationCode, MaritalStatus, MonthlyPremiumAuto, MonthsSinceLastClaim, MonthsSincePolicyInception, NumberofOpenComplaints, NumberofPoliciesPolicyType, Policy, RenewOfferType, SalesChannel, TotalClaimAmountVehicleClass, VehicleSize</p>

<p>Continues Independed Variables are : CustomerLifetimeValue, Income,MonthlyPremiumAuto, MonthsSinceLastClaim, MonthsSincePolicyInception, NumberofOpenComplaints, NumberofPolicies, TotalClaimAmount</p>

<p>There are no null values, so no further action required to replace missing or null values. "Customer" column is serial number so it is insignificat for analysis and removed from the dataset.</p>

<p>The unique values for each variable are as follows:</p>

```{r echo=FALSE}
Insurance <- read.csv("E:/neha/studies/trent study material/extra projects/kaggle/Insurance dataset statistical analysis for CLV/insurance_data.csv")

#Cleaning and Manipulating

Insurance <- Insurance[,-c(1)]
colnames(Insurance) <- str_replace_all(colnames(Insurance),"[.]","_")


#dim(Insurance)
#str(Insurance)

#na_counts <- sapply(Insurance, function(y) sum(is.na(y)))
#na_counts <- data.frame(na_counts)


#Find Unique values
unique_values <- lapply(Insurance, unique)
count_unique <- lengths(unique_values)
print(count_unique)


```


## Objective of Analysis:

<p>The objective of this analysis is to **Predict the Customer Lifetime Value of the Customers (CLV)**. Customer lifetime value is the metric that indicates the total revenue a business can reasonably expect from a single customer account. It represents the amount of money that a customer is expected is spend on a particular company's product or services. This metric can help the Auto Insurance Company to decide on the amount of money to invest in retaining the existing customers and acquiring new customers.</p>

<p>CLV is calculated as:</p>

* **Calculate average purchase value**: Calculate this number by dividing your company's total revenue in a time period (usually one year) by the number of purchases over the course of that same time period.

* **Calculate average purchase frequency rate**: Calculate this number by dividing the number of purchases by the number of unique customers who made purchases during that time period.

* **Calculate customer value**: Calculate this number by multiplying the average purchase value by the average purchase frequency rate.

* **Calculate average customer lifespan**: Calculate this number by averaging the number of years a customer continues purchasing from your company.

* **Calculate CLTV**: multiply customer value by the average customer lifespan. This will give you the revenue you can reasonably expect an average customer to generate for your company over the course of their relationship with you.

## Exploratory Analysis to discover interesting patterns:

### Customer Lifetime Value:

```{r echo=FALSE}
summary(Insurance$Customer_Lifetime_Value)

histogram1<-ggplot(Insurance, aes(x=Customer_Lifetime_Value)) + 
  geom_histogram(color="Black", fill="Yellow") + 
  geom_vline(aes(xintercept=mean(Customer_Lifetime_Value)),
             color="blue", linetype="dashed", size=1) +
  ggtitle("Histogram of Customer Lifetime Value") +
  theme(plot.title = element_text(hjust = 0.5))
histogram1
```

The histogram indicates a distribution that is heavily skewed with a very large tail. There are a lot of Customers with low CLV. Very few customers with high CLV.

###Monthly Premium Auto


```{r echo=FALSE}
summary(Insurance$Monthly_Premium_Auto)
histogram2<-ggplot(Insurance, aes(x=Monthly_Premium_Auto)) + 
  geom_histogram(color="Black", fill="Yellow") + 
  geom_vline(aes(xintercept=mean(Monthly_Premium_Auto)),
             color="blue", linetype="dashed", size=1) +
  ggtitle("Histogram of Monthly Premium Auto") +
  theme(plot.title = element_text(hjust = 0.5))

scatter2 <- ggplot(Insurance, aes(x = Monthly_Premium_Auto, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs MPA") +
  theme(plot.title = element_text(hjust = 0.5))

ggarrange(histogram2, scatter2, 
          ncol = 2, nrow = 1)
```

From the scatter plot, it is clearly visible that on MPA, CLV is also Increasing.
Monthly premiums follow a trend similar to CLV although the distribution is NOT as skewed or as long tailed as CLV. 

### Total Claim Amount


```{r echo=FALSE}
summary(Insurance$Total_Claim_Amount)

histogram3<-ggplot(Insurance, aes(x=Total_Claim_Amount)) + 
  geom_histogram(color="Black", fill="Yellow") + 
  geom_vline(aes(xintercept=mean(Total_Claim_Amount)),
             color="blue", linetype="dashed", size=1) +
  ggtitle("Histogram of Total Claim Amount") +
  theme(plot.title = element_text(hjust = 0.5))


scatter3 <- ggplot(Insurance, aes(x = Total_Claim_Amount, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs TCA") +
  theme(plot.title = element_text(hjust = 0.5))

ggarrange(histogram3, scatter3, 
          ncol = 2, nrow = 1)
```

### Relationship between CLV and continous variables

```{r echo=FALSE}
a1 <- ggplot(Insurance, aes(x = Customer_Lifetime_Value, y = Income)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("CLV Vs Income") +
  theme(plot.title = element_text(hjust = 0.5))
a2 <- ggplot(Insurance, aes(x = Customer_Lifetime_Value, y = Months_Since_Last_Claim)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("CLV Vs Months Since Last Claim") +
  theme(plot.title = element_text(hjust = 0.5))
a3 <- ggplot(Insurance, aes(x = Customer_Lifetime_Value, y = Months_Since_Policy_Inception)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("CLV Vs Months Since Policy Inception") +
  theme(plot.title = element_text(hjust = 0.5))
a4 <- ggplot(Insurance, aes(x = Customer_Lifetime_Value, y = Number_of_Open_Complaints)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("CLV Vs Number of Open Complaints") +
  theme(plot.title = element_text(hjust = 0.5))
grid.newpage()
grid.draw(cbind(ggplotGrob(a1), ggplotGrob(a2), size = "last"))
grid.newpage()
grid.draw(cbind(ggplotGrob(a3), ggplotGrob(a4), size = "last"))
ggplot(Insurance, aes(x = Customer_Lifetime_Value, y = Number_of_Policies)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("CLV Vs Number of Policies") +
  theme(plot.title = element_text(hjust = 0.5))

```

Looking at the plots above, the following points can be concluded:

* Customer lifetime value is less when the total claim amount is less.
* There are more people with less customer lifetime value and the data is skewed.
* As the number of open complaints increase, the customer lifetime value is decreases.

### Correlations with Customer Values

#### Correlation of Income with CLV

```{r echo=FALSE}
cor(Insurance$Income, Insurance$Customer_Lifetime_Value)
```

Since, the correlation value between CLV and Income is slightly greater than 0, as Income increases, so does the CLV of the customer. But these values are loosely correlated. 

#### Correlation of Monthly Auto Premium with CLV

```{r echo=FALSE}
cor(Insurance$Monthly_Premium_Auto, Insurance$Customer_Lifetime_Value)
```
Since, the correlation value between CLV and Monthly Auto Premium is greater than 0, as Monthly Auto Premium increases, so does the CLV of the customer. 

#### Correlation of Months since last claim with CLV

```{r echo=FALSE}
cor(Insurance$Months_Since_Last_Claim, Insurance$Customer_Lifetime_Value)
```
Since, the correlation value between CLV and Months since last claim is slightly greater than 0, as Months since last claim increases, so does the CLV of the customer. But these values are loosely correlated. 

#### Correlation of Months since policy inception with CLV

```{r echo=FALSE}
cor(Insurance$Months_Since_Policy_Inception, Insurance$Customer_Lifetime_Value)
```

Since, the correlation value between CLV and Months since inception of the policy is slightly greater than 0, as Months since inception of the policy increases, so does the CLV of the customer. But these values are very loosely correlated. 

#### Correlation of Total Claim Amount

```{r echo=FALSE}
cor(Insurance$Total_Claim_Amount, Insurance$Customer_Lifetime_Value)
```

Since, the correlation value between CLV and Total Claim Amount of the policy is  greater than 0, as Total Claim Amount increases, so does the CLV of the customer. 

#### Correlation of Number of Open Complaints

```{r echo=FALSE}
cor(Insurance$Number_of_Open_Complaints, Insurance$Customer_Lifetime_Value)
```

Since, the correlation value between CLV and Number of Complaints of the policy is slightly lesser than 0, the CLV increases as Number of Complaints decreases. 

To summarise, CLV increases as Total Claim Amount, Months since policy inception, Months since last claim and income increases. CLV decreases as Number of open complaints decrease.

## Inferential Statistics

```{r echo=FALSE}
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Coverage = Insurance$Coverage), FUN = sum)

p0 <- ggplot(data = aggData, aes(x = Coverage, y = prop.table(stat(aggData$x)), fill = Coverage, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Coverage', y = 'CLV in Percentage', fill = 'Coverage') + 
  ggtitle("CLV Distribution by Coverage")
p0

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Education = Insurance$Education), FUN = sum)
p1 <- ggplot(data = aggData, aes(x = Education, y = prop.table(stat(aggData$x)), fill = Education, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Education') + 
  ggtitle("CLV Distribution by Education")
p1

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Employment_Status = Insurance$EmploymentStatus), FUN = sum)
p2 <- ggplot(data = aggData, aes(x = Employment_Status, y = prop.table(stat(aggData$x)), fill = Employment_Status, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Employment_Status') + 
  ggtitle("CLV Distribution by Employment Status")
p2
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Gender = Insurance$Gender), FUN = sum)
p3 <- ggplot(data = aggData, aes(x = Gender, y = prop.table(stat(aggData$x)), fill = Gender, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Gender') + 
  ggtitle("CLV Distribution by Gender")
p3

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Location = Insurance$Location_Code), FUN = sum)
p4 <- ggplot(data = aggData, aes(x = Location, y = prop.table(stat(aggData$x)), fill = Location, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Location') + 
  ggtitle("CLV Distribution by Location")
p4
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Marital_Status = Insurance$Marital_Status), FUN = sum)
p5 <- ggplot(data = aggData, aes(x = Marital_Status, y = prop.table(stat(aggData$x)), fill = Marital_Status, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Marital Status') + 
  ggtitle("CLV Distribution by Marital Status")
p5
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Policy_Type = Insurance$Policy_Type), FUN = sum)
p6 <- ggplot(data = aggData, aes(x = Policy_Type, y = prop.table(stat(aggData$x)), fill = Policy_Type, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Policy_Type', y = 'CLV in Percentage', fill = 'Policy Type') + 
  ggtitle("CLV Distribution by Policy Type")
p6
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Policy_Type = Insurance$Policy_Type), FUN = sum)
p7 <- ggplot(data = aggData, aes(x = Policy_Type, y = prop.table(stat(aggData$x)), fill = Policy_Type, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Policy_Type', y = 'CLV in Percentage', fill = 'Policy Type') + 
  ggtitle("CLV Distribution by Policy Type")
p7
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Renew_Offer_Type = Insurance$Renew_Offer_Type), FUN = sum)
p8 <- ggplot(data = aggData, aes(x = Renew_Offer_Type, y = prop.table(stat(aggData$x)), fill = Renew_Offer_Type, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
 scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Renew_Offer_Type', y = 'CLV in Percentage', fill = 'Renew_Offer_Type') + 
  ggtitle("CLV Distribution by Renew Offer Type")
p8
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Sales_Channel = Insurance$Sales_Channel), FUN = sum)
p9 <- ggplot(data = aggData, aes(x = Sales_Channel, y = prop.table(stat(aggData$x)), fill = Sales_Channel, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
labs(x = 'Sales_Channel', y = 'CLV in Percentage', fill = 'Sales_Channel') + 
  ggtitle("CLV Distribution by Sales_Channel")
p9
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Vehicle_Class = Insurance$Vehicle_Class), FUN = sum)
p10 <- ggplot(data = aggData, aes(x = Vehicle_Class, y = prop.table(stat(aggData$x)), fill = Vehicle_Class, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Vehicle_Class', y = 'CLV in Percentage', fill = 'Vehicle_Class') + 
  ggtitle("CLV Distribution by Vehicle Class")
p10
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(State = Insurance$State), FUN = sum)
p11 <- ggplot(data = aggData, aes(x = State, y = prop.table(stat(aggData$x)), fill = State, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'State', y = 'CLV in Percentage', fill = 'State') + 
  ggtitle("CLV Distribution by State")
p11
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Policy = Insurance$Policy), FUN = sum)
p12 <- ggplot(data = aggData, aes(x = Policy, y = prop.table(stat(aggData$x)), fill = Policy, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Policy', y = 'CLV in Percentage', fill = 'Policy') + 
  ggtitle("CLV Distribution by Policy")
p12

```

Looking at the graphs above, the customers that are most important to the Auto Insurance company are:

* 54.8% customers favour the basic coverage.
* Customers with Bachelors, College or High school education are more valuable.
* 64.1% of the CLV is contributed by Employed people.
* Both Female and Male customers are equally important.
* People living in Suburban districts are buying more auto insurance.
* Married people contribute more to the company in term of auto insurance.
* Personal auto insurance is favoured more.
* Auto insurance sales are generated more through an agent as opposed to call centres, website or branch.
* Customers with four door car are customers with high lifetime value.
* This company sells more in California state.
* Personal L3 policy is more favoured.

## Regression analysis

Dependent Variable CLV is continuous and we have seen that independent variables are mostly depending linearly with dependent Variable, So Linear Regression algorithm is best for this type of this Data. The goal of the Linear regression is to find the best fit line that can accurately predict the output for the continuous dependent variable. The CLV variable is analysed with 8 continous variables.

```{r echo=FALSE}
Continous_data <- dplyr::select_if(Insurance, ~!is.factor(.))
str(Continous_data)

trainIndex <- createDataPartition(Continous_data$Customer_Lifetime_Value, p=0.70, list = FALSE)
#print(trainIndex)
# 70% Train dataset for regression analysis
insuranceTrain <- Continous_data[trainIndex,]
# Remaining 30% Test dataset for testing
insuranceTest <- Continous_data[-trainIndex,]

regression1 <- lm(insuranceTrain$Customer_Lifetime_Value ~., data = insuranceTrain) 
summary(regression1)
```

**Null Hypothesis** - None of the independed variables are significant for CLV.

**Alternate Hypothesis** - At least one of the independent variables are significant and can effect the CLV.

The model tells us that:

* p-value of model is less than 0.05, so atleast one of the independent variables are significant.
* p-value of MonthlyPremiumAuto, NumberofOpenComplaints and NumberofPolicies are less then 0.05, so rejecting the null hypothesis. So atlest one of them independed variables are significant and can effect the CLV.
* R squared is 16.02% which explains the variance found in the CLV.
* Residual standard error is 6322 which is very very high, so it means the actual CLV will deviate from the true regression line by approximately 6322 on an average. The smaller the standard error, the less the spread and the more likely it is that any sample mean is close to the population mean. A small standard error is thus a Good Thing.
* Gap between R-squared and Adjusted R-squared is 1.4% only, which is good. Typically the more non-significant variables you add into the model, the gap between two increases.
* F-statistic: 6.958 - The lower the F-statistic, the closer to a non-significant model. So F-statistic is low means it is not very significant model.

Since there is more than one significant variable, there is a need to rerun the model with only significant variables.

```{r echo=FALSE}
regression2 <- lm(insuranceTrain$Customer_Lifetime_Value ~ 
                Monthly_Premium_Auto + Number_of_Open_Complaints + Number_of_Policies + Total_Claim_Amount, 
              data = insuranceTrain) 
summary(regression2)
```

The estimated regression line equation can be written as follow:

CLV = 582.9 + 82.6 MPA - 243.4 NoOC + 75.0 NoP - 0.9 TCA

**Null Hypothesis** - None of the independed variables are significant for CLV.

**Alternate Hypothesis** - At least one of the independent variables are significant and can effect the CLV.

The new model can be interpreted as:

* p-value of MonthlyPremiumAuto, NumberofOpenComplaints, NumberofPolicies and TotalClaimAmount is less than 0.05 so they are significantly impact the CLV.

* Coefficients of Independent Variables :-

    + MonthlyPremiumAuto : 86.4478. One unit increase in MonthlyPremiumAuto will increase CLV by 86.4478

    + NumberofOpenComplaints : -199.3526. One unit increase in NumberofOpenComplaints will decrease CLV by 199.3526

    + NumberofPolicies : 76.3861. One unit increase in NumberofPolicies will increase CLV by 76.3861

    + TotalClaimAmount : -1.0445. one unit increase in TotalClaimAmount will decrease by 1.0445

**So the customers having more number of policies with high monthly premium will add more value to company.**

**On the other hand, customer's Open Complaints and More Claim Amount will decrease the CLV.**

## Predicting the value of CLV

```{r echo=FALSE}
predicted_CLV <- predict(regression2)  

residualsCLV <- residuals(regression2)


predicatedTestData=predict(regression2,insuranceTest)


InsuranceTrainData <- cbind(insuranceTrain,predicted_CLV,residualsCLV)
head(InsuranceTrainData)
```

## Prediction Curve

Blue line show the regression line and red dot shoes the actual observations deviated from the regression line.

```{r echo=FALSE}
x1 <- ggplot(InsuranceTrainData, aes(x = Monthly_Premium_Auto, y = Customer_Lifetime_Value)) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +     # regression line  
  geom_segment(aes(xend = Monthly_Premium_Auto, yend = predicted_CLV), alpha = .2) +      # draw line from point to line
  geom_point(aes(color = abs(residualsCLV), size = abs(residualsCLV))) +  # size of the points
  scale_color_continuous(low = "green", high = "red") +             # colour of the points mapped to residual size - green smaller, red larger
  guides(color = FALSE, size = FALSE) +                             # Size legend removed
  geom_point(aes(y = predicted_CLV), shape = 1) +
  theme_bw() +
  ggtitle("Prediction curve with Monthly Premium Auto")
x1

x2 <- ggplot(InsuranceTrainData,aes(x=Monthly_Premium_Auto,y=Customer_Lifetime_Value))+
  geom_point(color="red")+
  stat_smooth(method="lm")+
  scale_x_continuous(name="Monthly Premium")+
  scale_y_continuous(name="Prediction of CLV")+
  ggtitle("Prediction Curve with Monthly Premium")
x2

x3 <- ggplot(InsuranceTrainData,aes(x=Total_Claim_Amount,y=Customer_Lifetime_Value))+
  geom_point(color="red")+
  stat_smooth(method="lm")+
  scale_x_continuous(name="Total Claim Amount")+
  scale_y_continuous(name="Prediction of CLV")+
  ggtitle("Prediction Curve with Total Claim Amount")
x3
```

## Summary

* There are a lot of Customers with low CLV. Very few customers with high CLV.
Customers who have taken Basic Insurance for their vehicle are more valuable then Extended or Premium Insurance Policy holders.
* Educated Employed customers (with a bachelors or equivalent degree) are more valuable than Retired, Unemployed or Disabled Customers.
* Gender has no role to play in determining the value of a customer. Both Male and Female looks valuable.
* Marital customers are buying more auto insurance and adding more value to company.
Rural customers are LESS valuable than Urban customers.
* Customers having their own Personal Policy are more valuable to company then Corporate and Special Insurance policy holder.
* Offers 1 and Offer 2 attracts more customers.
* Call Center is not performing well compared to other channels throughout the country (in terms of high value customers)
* Customers having Mid Size vehicles, Four-Door car or SUV are more valuable.
California customers are adding more value to the company.
* Personal L3 Policy is adding more value to company.xiii.
* The customers having more number of policies with high monthly premium will add more value to company. On the other hand, customer's Open Complaints and More Claim Amount will decrease the CLV.

## Marketing Recommendations

* Insurance company should target educated married employed customers from Urban areas having Mid Size vehicles to increase the Customer Lifetime Value (CLV) increase.

* On the other hand, if customer's Open Complaints would not be resolved soon and claim amount would not bring down, then both could decrease the Customer Lifetime Value (CLV).

* About 38% value was added by the agents to the company whereas call centers added only 20% value. So agents should be preferred over call centers while selling the auto insurance to customers.

* Factors which are responsible for increasing the CLV are Monthly Premium and Number of Policies, however Open Complaints and Claim Amount can decrease the CLV.

## R Code

```{r eval=FALSE}
# Importing packages
library(tidyverse) 
library(car) 
library(zoo)
library(lmtest) 
library(dplyr) 
library(stringr)
library(caret)
library(ggplot2) 
library(timeDate)
library(varhandle)
library(gridExtra)
library(grid)
install.packages("grid")
#install.packages("timeDate")

install.packages("devtools")
library(devtools)
install_github("easyGgplot2", "kassambara")

Insurance <- read.csv("E:/neha/studies/trent study material/extra projects/kaggle/Insurance dataset statistical analysis for CLV/insurance_data.csv")

head(Insurance)

#Cleaning and Manipulating

Insurance <- Insurance[,-c(1)]
colnames(Insurance)
colnames(Insurance) <- str_replace_all(colnames(Insurance),"[.]","_")
colnames(Insurance)

dim(Insurance)
str(Insurance)

na_counts <- sapply(Insurance, function(y) sum(is.na(y)))
na_counts <- data.frame(na_counts)
na_counts

#Find Unique values
unique_values <- lapply(Insurance, unique)
count_unique <- lengths(unique_values)
print(count_unique)

#Exploratory Analysis

#For Customer lifetime value

summary(Insurance$Customer_Lifetime_Value)
sd(Insurance$Customer_Lifetime_Value)
histogram1<-ggplot(Insurance, aes(x=Customer_Lifetime_Value)) + 
  geom_histogram(color="Black", fill="Yellow") + 
  geom_vline(aes(xintercept=mean(Customer_Lifetime_Value)),
             color="blue", linetype="dashed", size=1) +
  ggtitle("Histogram of Customer Lifetime Value") +
  theme(plot.title = element_text(hjust = 0.5))
histogram1

#Monthly Premium Auto

summary(Insurance$Monthly_Premium_Auto)
sd(Insurance$Monthly_Premium_Auto)
histogram2<-ggplot(Insurance, aes(x=Monthly_Premium_Auto)) + 
  geom_histogram(color="Black", fill="Yellow") + 
  geom_vline(aes(xintercept=mean(Monthly_Premium_Auto)),
             color="blue", linetype="dashed", size=1) +
  ggtitle("Histogram of Monthly Premium Auto") +
  theme(plot.title = element_text(hjust = 0.5))
histogram2

ggplot(Insurance, aes(x = Monthly_Premium_Auto, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs MPA") +
  theme(plot.title = element_text(hjust = 0.5))

# Total Claim Amount

summary(Insurance$Total_Claim_Amount)
sd(Insurance$Total_Claim_Amount)
histogram3<-ggplot(Insurance, aes(x=Total_Claim_Amount)) + 
  geom_histogram(color="Black", fill="Yellow") + 
  geom_vline(aes(xintercept=mean(Total_Claim_Amount)),
             color="blue", linetype="dashed", size=1) +
  ggtitle("Histogram of Total Claim Amount") +
  theme(plot.title = element_text(hjust = 0.5))
histogram3

ggplot(Insurance, aes(x = Total_Claim_Amount, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs TCA") +
  theme(plot.title = element_text(hjust = 0.5))

#Income

ggplot(Insurance, aes(x = Income, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs Income") +
  theme(plot.title = element_text(hjust = 0.5))

#Months since last claim

ggplot(Insurance, aes(x = Months_Since_Last_Claim, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs Months Since Last Claim") +
  theme(plot.title = element_text(hjust = 0.5))

#Months since Policy Inception

ggplot(Insurance, aes(x = Months_Since_Policy_Inception, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs Months Since Policy Inception") +
  theme(plot.title = element_text(hjust = 0.5))

#Number of Open Complaints

ggplot(Insurance, aes(x = Number_of_Open_Complaints, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs Number of Open Complaints") +
  theme(plot.title = element_text(hjust = 0.5))

#Number of Policies

ggplot(Insurance, aes(x = Number_of_Policies, y = Customer_Lifetime_Value)) +
  geom_point(color="Orange") +
  stat_smooth(method = "lm",
              col = "#C42126",
              se = FALSE,
              size = 1) +
  ggtitle("Scatterplot of CLV Vs Number of Policies") +
  theme(plot.title = element_text(hjust = 0.5))

#Correlations of all columns with Customer lifetime Value


cor(Insurance$Income, Insurance$Customer_Lifetime_Value)
cor(Insurance$Monthly_Premium_Auto, Insurance$Customer_Lifetime_Value)
cor(Insurance$Months_Since_Last_Claim, Insurance$Customer_Lifetime_Value)
cor(Insurance$Months_Since_Policy_Inception, Insurance$Customer_Lifetime_Value)
cor(Insurance$Total_Claim_Amount, Insurance$Customer_Lifetime_Value)
cor(Insurance$Number_of_Open_Complaints, Insurance$Customer_Lifetime_Value)

#Inferential Statistics

#Bar Plots

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Coverage = Insurance$Coverage), FUN = sum)

p0 <- ggplot(data = aggData, aes(x = Coverage, y = prop.table(stat(aggData$x)), fill = Coverage, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Coverage', y = 'CLV in Percentage', fill = 'Coverage') + 
  ggtitle("CLV Distribution by Coverage")
p0

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Education = Insurance$Education), FUN = sum)
p1 <- ggplot(data = aggData, aes(x = Education, y = prop.table(stat(aggData$x)), fill = Education, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Education') + 
  ggtitle("CLV Distribution by Education")
p1

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Employment_Status = Insurance$EmploymentStatus), FUN = sum)
p2 <- ggplot(data = aggData, aes(x = Employment_Status, y = prop.table(stat(aggData$x)), fill = Employment_Status, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Employment_Status') + 
  ggtitle("CLV Distribution by Employment Status")
p2
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Gender = Insurance$Gender), FUN = sum)
p3 <- ggplot(data = aggData, aes(x = Gender, y = prop.table(stat(aggData$x)), fill = Gender, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Gender') + 
  ggtitle("CLV Distribution by Gender")
p3

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Location = Insurance$Location_Code), FUN = sum)
p4 <- ggplot(data = aggData, aes(x = Location, y = prop.table(stat(aggData$x)), fill = Location, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Location') + 
  ggtitle("CLV Distribution by Location")
p4
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Marital_Status = Insurance$Marital_Status), FUN = sum)
p5 <- ggplot(data = aggData, aes(x = Marital_Status, y = prop.table(stat(aggData$x)), fill = Marital_Status, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Education', y = 'CLV in Percentage', fill = 'Marital Status') + 
  ggtitle("CLV Distribution by Marital Status")
p5
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Policy_Type = Insurance$Policy_Type), FUN = sum)
p6 <- ggplot(data = aggData, aes(x = Policy_Type, y = prop.table(stat(aggData$x)), fill = Policy_Type, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Policy_Type', y = 'CLV in Percentage', fill = 'Policy Type') + 
  ggtitle("CLV Distribution by Policy Type")
p6

aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Sales_Channel = Insurance$Sales_Channel), FUN = sum)
p9 <- ggplot(data = aggData, aes(x = Sales_Channel, y = prop.table(stat(aggData$x)), fill = Sales_Channel, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
labs(x = 'Sales_Channel', y = 'CLV in Percentage', fill = 'Sales_Channel') + 
  ggtitle("CLV Distribution by Sales_Channel")
p9
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Vehicle_Class = Insurance$Vehicle_Class), FUN = sum)
p10 <- ggplot(data = aggData, aes(x = Vehicle_Class, y = prop.table(stat(aggData$x)), fill = Vehicle_Class, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Vehicle_Class', y = 'CLV in Percentage', fill = 'Vehicle_Class') + 
  ggtitle("CLV Distribution by Vehicle Class")
p10
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(State = Insurance$State), FUN = sum)
p11 <- ggplot(data = aggData, aes(x = State, y = prop.table(stat(aggData$x)), fill = State, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'State', y = 'CLV in Percentage', fill = 'State') + 
  ggtitle("CLV Distribution by State")
p11
aggData <- aggregate(x = Insurance$Customer_Lifetime_Value, by=list(Policy = Insurance$Policy), FUN = sum)
p12 <- ggplot(data = aggData, aes(x = Policy, y = prop.table(stat(aggData$x)), fill = Policy, label = scales::percent(prop.table(stat(aggData$x))))) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_text(stat = 'identity', position = position_dodge(.9),  vjust = -0.5, size = 3) + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = 'Policy', y = 'CLV in Percentage', fill = 'Policy') + 
  ggtitle("CLV Distribution by Policy")
p12

#grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12, p13, nrow=3)

#Regression Analysis

Continous_data <- dplyr::select_if(Insurance, ~!is.factor(.))
str(Continous_data)

trainIndex <- createDataPartition(Continous_data$Customer_Lifetime_Value, p=0.70, list = FALSE)
#print(trainIndex)
# 70% Train dataset for regression analysis
insuranceTrain <- Continous_data[trainIndex,]
# Remaining 30% Test dataset for testing
insuranceTest <- Continous_data[-trainIndex,]

dim(Continous_data)
dim(insuranceTest)
dim(insuranceTrain)

#Linear Regression analysis using all continous variables

regression1 <- lm(insuranceTrain$Customer_Lifetime_Value ~., data = insuranceTrain) 
summary(regression1)

#Linear Regression with only significant variables

regression2 <- lm(insuranceTrain$Customer_Lifetime_Value ~ 
                Monthly_Premium_Auto + Number_of_Open_Complaints + Number_of_Policies + Total_Claim_Amount, 
              data = insuranceTrain) 
summary(regression2)

predicted_CLV <- predict(regression2)  
#print predicted CLV.
print(predicted_CLV[1:10])

#print actual CLV to compare it with above calculated predicted CLV.
print(insuranceTrain$Customer_Lifetime_Value[1:10])

residualsCLV <- residuals(regression2)
print(residualsCLV[1:10])

predicatedTestData=predict(regression2,insuranceTest)
print(predicatedTestData[1:10])

InsuranceTrainData <- cbind(insuranceTrain,predicted_CLV,residualsCLV)
head(InsuranceTrainData)

ErrorRate <- abs((InsuranceTrainData$Customer_Lifetime_Value - InsuranceTrainData$predicted_CLV)/(InsuranceTrainData$Customer_Lifetime_Value)*100)
print(ErrorRate[1:10])

InsuranceTrainData <- cbind(InsuranceTrainData, ErrorRate)
head(InsuranceTrainData)


hist(ErrorRate, col = "Red")
boxplot(ErrorRate)

shapiro.test(residualsCLV[0:5000])
plot(regression2, which=1, col=c("blue"))

ggplot(InsuranceTrainData, aes(x = Monthly_Premium_Auto, y = Customer_Lifetime_Value)) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +     # regression line  
  geom_segment(aes(xend = Monthly_Premium_Auto, yend = predicted_CLV), alpha = .2) +      # draw line from point to line
  geom_point(aes(color = abs(residualsCLV), size = abs(residualsCLV))) +  # size of the points
  scale_color_continuous(low = "green", high = "red") +             # colour of the points mapped to residual size - green smaller, red larger
  guides(color = FALSE, size = FALSE) +                             # Size legend removed
  geom_point(aes(y = predicted_CLV), shape = 1) +
  theme_bw()

ggplot(InsuranceTrainData,aes(x=Monthly_Premium_Auto,y=Customer_Lifetime_Value))+
  geom_point(color="red")+
  stat_smooth(method="lm")+
  scale_x_continuous(name="Monthly Premium")+
  scale_y_continuous(name="Prediction of CLV")+
  ggtitle("Prediction Curve with Monthly Premium")

ggplot(InsuranceTrainData,aes(x=Total_Claim_Amount,y=Customer_Lifetime_Value))+
  geom_point(color="red")+
  stat_smooth(method="lm")+
  scale_x_continuous(name="Total Claim Amount")+
  scale_y_continuous(name="Prediction of CLV")+
  ggtitle("Prediction Curve with Total Claim Amount")
```